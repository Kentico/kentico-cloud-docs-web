/**
 * Initializes lightbox and caption if available
 */
(() => {
  const showCloseButtonOnElemLoaded = (elemSelector, instance) => {
    const close = document.querySelector('.basicLightbox__close-container--hidden');
    const elem = document.querySelector(`.basicLightbox__close-container + ${elemSelector}`);
    var interval = setInterval(function () {
      if (close && elem) {
        if (elem.clientWidth > 0) {
          close.classList.remove('basicLightbox__close-container--hidden');
          close.querySelector('.basicLightbox__close').addEventListener('click', function () {
            instance.close();
          });
          clearInterval(interval);
        }
      }
    }, 250);
  };

  const registerCloseOnEsc = (instance) => {
    document.onkeydown = function(e) {
      e = e || window.event;
      if (e.keyCode === 27 && instance && instance.close) {
        instance.close();
      }
    };
  };

  const initLightboxOnElemsAvailable = (selector, callback) => {
    const interval = setInterval(() => {
      const elems = document.querySelectorAll(selector);

      if (elems.length) {
        callback();
        clearInterval(interval);
      }
    }, 100);
  };

  const initLightboxOnImages = () => {
    setTimeout(() => {
      const initLightbox = () => {
        document.querySelectorAll('[data-lightbox-image]').forEach((item) => {
          let figcaption = '';
          const nextSibling = item.nextSibling;
          const nextNextSibling = nextSibling.nextSibling;

          // Find caption in DOM generated by Kentico Kontent
          const captionElem = (() => {
            if (nextSibling && nextSibling.tagName === 'FIGCAPTION') {
              return nextSibling;
            } else if (nextNextSibling && nextNextSibling.tagName === 'FIGCAPTION') {
              return nextNextSibling;
            } else {
              return null;
            }
          })();

          if (captionElem !== null) {
            figcaption = `<div class="basicLightbox__description">${captionElem.innerHTML}</div>`;
          }

          const width = item.getAttribute('width');
          const height = item.getAttribute('height');

          // Init lighbox with caption
          let instance;
          item.addEventListener('click', () => {
            instance = window.basicLightbox.create(`<div class="basicLightbox__close-container basicLightbox__close-container--hidden"><div class="basicLightbox__close"></div></div><img src="${item.getAttribute('src').split('?')[0] + '?w=1600&fm=pjpg&auto=format'}"${width ? ` width=${width}` : ''}${height ? ` height=${height}` : ''}>${figcaption}`);
            instance.show();
            showCloseButtonOnElemLoaded('img', instance);
            registerCloseOnEsc(instance);
          });
        });
      }

      initLightboxOnElemsAvailable('[data-lightbox-image]', initLightbox);
    }, 0);
  };

  const initLightboxOnEmbeds = () => {
    setTimeout(() => {
      const initLightbox = () => {
        document.querySelectorAll('[data-lightbox]').forEach((item) => {
          let figcaption = '';
          const figcaptionElem = item.parentNode.nextSibling;

          // Find caption in DOM generated by Kentico Kontent
          const captionElem = (() => {
            if (figcaptionElem && figcaptionElem.classList.contains('figcaption')) {
              return figcaptionElem;
            }
            return null;
          })();

          if (captionElem !== null) {
            figcaption = `<div class="basicLightbox__description">${captionElem.innerHTML}</div>`;
          }

          // Init lighbox
          let instance;
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const itemToZoom = document.querySelector(`#${item.getAttribute('data-lightbox')} iframe`);
            const wrap = document.createElement('div');
            wrap.appendChild(itemToZoom.cloneNode(true));

            if (itemToZoom) {
              instance = window.basicLightbox.create(`<div class="basicLightbox__close-container basicLightbox__close-container--hidden"><div class="basicLightbox__close"></div></div>${wrap.innerHTML}${figcaption}`);
              instance.show();
              showCloseButtonOnElemLoaded('iframe', instance);
              registerCloseOnEsc(instance);
            }
          });
        });
      }

      initLightboxOnElemsAvailable('[data-lightbox]', initLightbox);
    }, 0);
  };

  const initLightboxOnChangelog = () => {
    setTimeout(() => {
      const initLightbox = () => {
        document.querySelectorAll('[href="#subscribe-breaking-changes-email"]').forEach((item) => {
          // Init lighbox with caption
          let instance;
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const itemToZoom = '<div class="iframe-box"><div class="iframe-box__close"></div><iframe width="240" height="145" src="https://tracker.kontent.ai/l/849473/2020-04-21/4qsx" /></div>';

            if (itemToZoom) {
              instance = window.basicLightbox.create(itemToZoom);
              instance.show();
              registerCloseOnEsc(instance);
            }
          });
        });
      }

      initLightboxOnElemsAvailable('[href="#subscribe-breaking-changes-email"]', initLightbox);
    }, 0);
  };

  const initLightboxOnVideos = () => {
    setTimeout(() => {
      const initLightbox = () => {
        document.querySelectorAll('[data-lightbox-video]').forEach((item) => {
          let figcaption = '';
          let figcaptionElem = item.nextSibling;
          if (!figcaptionElem) {
            figcaptionElem = item.parentNode.nextSibling;
          }

          // Find caption in DOM generated by Kentico Kontent
          const captionElem = (() => {
            if (figcaptionElem && figcaptionElem.tagName === 'FIGCAPTION') {
              return figcaptionElem;
            }
            return null;
          })();

          if (captionElem !== null) {
            figcaption = `<div class="basicLightbox__description">${captionElem.innerHTML}</div>`;
          }

          console.log(figcaption)

          // Init lighbox
          let instance;
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const itemToZoom = item;
            const wrap = document.createElement('div');
            wrap.appendChild(itemToZoom.cloneNode(true));

            if (itemToZoom) {
              instance = window.basicLightbox.create(`<div class="basicLightbox__close-container basicLightbox__close-container--hidden"><div class="basicLightbox__close"></div></div>${wrap.innerHTML}${figcaption}`);
              instance.show();
              showCloseButtonOnElemLoaded('video', instance);
              registerCloseOnEsc(instance);
            }
          });
        });
      }

      initLightboxOnElemsAvailable('[data-lightbox-video]', initLightbox);
    }, 0);
  };

  initLightboxOnImages();
  initLightboxOnEmbeds();
  initLightboxOnChangelog();
  initLightboxOnVideos();
})();
